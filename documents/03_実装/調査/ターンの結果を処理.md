## 1. メインの処理フロー

**GameGrid.tsx の 2997行目付近 - `useEffect` でのWebSocketメッセージ受信処理:**

```tsx
const handleEnemyActionSubmitted = (data: WebSocketMessage) => {
  if (data.type === "enemy_action_submitted") {
    console.log("敵側のアクションを受信:", data);
    setEnemyActions(data.enemyActions || []);
    setCurrentTurn(data.turnNumber || 1);
    setGameMode("action");

    // ユニット行動開始をPhaser側に通知
    executeActionsEmitter.dispatchEvent(
      new CustomEvent("executeAllActions", {
        detail: {
          playerActions: [], // プレイヤーの行動履歴はPhaser側で取得
          enemyActions: data.enemyActions || [],
          turnNumber: data.turnNumber || 1,
        },
      })
    );
  }
};
```

## 2. Phaserシーン側での処理

**GameGrid.tsx の 515行目付近 - `setupActionModeListeners()` でのイベント受信:**

```tsx
private setupActionModeListeners() {
  const handleExecuteActions = (event: Event) => {
    const customEvent = event as CustomEvent;
    const { playerActions, enemyActions, turnNumber } = customEvent.detail;
    this.executeAllActions(playerActions, enemyActions, turnNumber);
  };

  executeActionsEmitter.addEventListener(
    "executeAllActions",
    handleExecuteActions
  );
}
```

## 3. 実際の行動実行処理

**GameGrid.tsx の 2231行目付近 - `executeAllActions()` メソッド:**

```tsx
private executeAllActions(
  playerActions: ActionData[],
  enemyActions: ActionData[],
  turnNumber: number
) {
  console.log(`ターン ${turnNumber} の行動実行開始`);
  this.isActionMode = true;
  this.actionAnimationInProgress = true;

  // 全キャラクターのトリガー方向を表示（行動モード専用）
  [...this.playerCharacters, ...this.enemyCharacters].forEach(
    (character) => {
      this.showTriggerDirections(character);
    }
  );

  // 現在の自分の行動履歴を取得
  const currentPlayerActions = this.getActionHistory();

  // ステップベースの移動システムを使用
  this.executeStepBasedActions(currentPlayerActions, enemyActions);
}
```

## 処理の流れ

1. **WebSocket受信**: `enemy_action_submitted` メッセージを受信
2. **React状態更新**: `setEnemyActions()`, `setCurrentTurn()`, `setGameMode("action")`
3. **Phaserへの通知**: `executeActionsEmitter` を使ってカスタムイベントを発火
4. **Phaserでの処理**: `executeAllActions()` メソッドで行動実行モードに移行
5. **キャラクター行動**: `executeStepBasedActions()` でプレイヤー・敵の行動を並列実行

現在の実装では、`turn_result` や `game_state_update` のメッセージタイプは定義されているものの、実際の処理は `enemy_action_submitted` メッセージのみが実装されています。敵のアクションデータを受信した時点で、即座にターンの行動実行フェーズに移行する仕組みになっています。