# 最後のアクションが反映されていない

## キャラクター04の最後の行動が反映されない問題の修正完了

### 問題の原因：

1. **タイミングの問題**: `consumeActionPoint()`で行動力を消費した瞬間に`checkAllCharactersActionPointsCompleted()`が呼ばれていました
2. **処理順序の問題**: 行動履歴を記録する`recordActionHistory()`よりも先に送信処理が実行されていました
3. **結果**: 最後の行動設定が完了する前に`submit_actions`が送信されてしまっていました

### 修正内容：

1. **`consumeActionPoint()`から即座のチェックを削除**
   - 行動力消費後の即座の`checkAllCharactersActionPointsCompleted()`呼び出しを削除
   - 行動力が0になった時の「行動設定済み」テキスト表示は維持

2. **`finishTriggerSetting()`で適切なタイミングでチェック**
   - 行動履歴記録（`recordActionHistory()`）が完了した後
   - トリガー設定が完全に終了した後
   - 全ての処理が完了してから`checkAllCharactersActionPointsCompleted()`を呼び出し

### 修正後の処理フロー：

1. キャラクターを移動先に移動
2. トリガー設定モード開始
3. mainトリガー設定完了
4. subトリガー設定完了
5. `finishTriggerSetting()`実行
   - 行動力を消費
   - **行動履歴を記録** ← この完了後に
   - トリガー設定モード終了
   - **全キャラクターの行動力チェック** ← 送信判定

これで、キャラクター04の最後の行動も含めて、すべての行動が確実に行動履歴に記録されてからサーバーに送信されるようになります。