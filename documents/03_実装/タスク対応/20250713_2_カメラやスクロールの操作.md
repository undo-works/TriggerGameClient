実装完了しました！ゲーム画面にスクロールと拡大縮小機能を追加しました。以下の機能が実装されています：

## 追加された機能

### 1. カメラ操作
- **マウスホイール**: ズームイン・ズームアウト (0.3倍から3.0倍まで)
- **右クリック + ドラッグ**: 画面をドラッグして移動
- **WASD キー**: カメラを移動（各方向に50ピクセル）
- **矢印キー**: カメラを移動（WASDキーと同じ機能）

### 2. 操作分離
- **左クリック**: 従来通りキャラクター選択・移動操作
- **右クリック・中クリック**: カメラ操作専用（ゲーム操作と競合しない）

### 3. カメラ境界設定
- グリッド全体をカバーする境界を設定
- 初期位置をマップ中央に設定
- 適切な世界サイズの計算

### 4. UI改善
- 操作説明パネルを左下に追加
- 拡大縮小の範囲を明示
- 操作方法を分かりやすく表示

### 5. パフォーマンス最適化
- カメラ移動時の適切なスクロール速度
- ズーム時の適切なファクター設定
- ドラッグ操作の滑らかな追従

この実装により、36×36の大きなマップでも自由に視点を移動でき、必要に応じて拡大縮小して詳細を確認できるようになります。既存のゲーム操作は左クリックで継続して使用でき、カメラ操作は右クリックで明確に分離されています。

## 修正された問題点

### 問題1: 拡大縮小時のマウスポインタのズレ
**修正内容:**
- `pixelToHex`関数を修正してカメラのズーム・スクロールを考慮
- `calculateMouseAngle`関数を修正してトリガー設定時の角度計算も対応
- マウスホイールでのズーム時にマウスポインタを中心としたズーム処理を実装

**修正箇所:**
```typescript
// カメラのズームとスクロールを考慮した座標変換
const camera = this.cameras.main;
const worldX = (x + camera.scrollX) / camera.zoom;
const worldY = (y + camera.scrollY) / camera.zoom;
```

### 問題2: 右クリックや矢印キーでのカメラ移動ができない
**修正内容:**
- `setupCamera`メソッドと`createMouseInteraction`メソッドのイベント処理を統合
- 右クリックドラッグ処理を`createMouseInteraction`メソッドに移動
- キーボードイベントの処理を修正して確実に動作するように改善

**修正箇所:**
```typescript
// カメラドラッグ用の変数を追加
let isDraggingCamera = false;
let dragStartX = 0;
let dragStartY = 0;
let cameraStartX = 0;
let cameraStartY = 0;

// 右クリックドラッグ処理
if (pointer.rightButtonDown() || pointer.middleButtonDown()) {
  isDraggingCamera = true;
  dragStartX = pointer.x;
  dragStartY = pointer.y;
  cameraStartX = this.cameras.main.scrollX;
  cameraStartY = this.cameras.main.scrollY;
  return;
}
```

### 追加改善点
- **マウスポインタを中心としたズーム**: ズーム時にマウスカーソルが指している位置を中心に拡大縮小
- **滑らかなドラッグ操作**: 右クリックドラッグ時の滑らかなカメラ移動
- **キーボード操作の確実性**: WASD・矢印キーでのカメラ移動が確実に動作

これらの修正により、直感的で使いやすいカメラ操作が実現されました。

## 三段階固定ズーム機能の追加

### 背景
連続的なマウスホイールズームでマウスポインタのズレが発生する問題を解決するため、三段階の固定ズームレベルに変更しました。

### 実装内容

#### 1. 固定ズームレベルの設定
```typescript
// 三段階のズームレベル
const zoomLevels = [0.5, 1.0, 2.0]; // 縮小、普通、拡大
const zoomLabels = ["縮小", "普通", "拡大"];
let currentZoomIndex = 1; // 初期値は普通（1.0）
```

#### 2. マウスホイールでの段階的ズーム
- マウスホイールの上下で3段階のズームレベルを切り替え
- 複雑な座標計算を排除し、単純な段階切り替えに変更
- ズームレベルの変更をReact側に通知

#### 3. UIコントロールの追加
- **ズームボタン**: 縮小・普通・拡大を直接選択可能
- **現在のズーム表示**: 現在のズーム倍率を表示
- **操作説明の更新**: 新しい操作方法を明記

#### 4. 利点
- **ポインタのズレなし**: 固定レベルなので座標計算エラーが発生しない
- **直感的な操作**: 3段階の明確な選択肢
- **UI操作との連携**: ボタンクリックとマウスホイールの両方で操作可能
- **状態の可視化**: 現在のズームレベルが明確に表示される

### UIの改善
- **左上にズームコントロール**: 3つのボタンで直接ズームレベルを選択
- **現在のズーム表示**: 0.5x、1.0x、2.0xの表示
- **操作説明の更新**: マウスホイールの説明を「3段階ズーム切り替え」に変更

この変更により、マウスポインタのズレ問題を完全に解決し、より使いやすいカメラ操作を実現しました。

## UI表示問題の修正

### 問題
マップの上部が見切れてしまい、ズームコントロールが表示されない問題が発生していました。

### 修正内容

#### 1. Phaserゲームサイズの調整
```typescript
// 画面サイズに合わせてゲームサイズを調整
const config: Phaser.Types.Core.GameConfig = {
  width: Math.min(1200, window.innerWidth - 40), // 画面幅に合わせて調整
  height: Math.min(800, window.innerHeight - 40), // 画面高さに合わせて調整
  // ...
};
```

#### 2. UIレイアウトの改善
- **コンテナのレスポンシブ化**: `w-full h-screen overflow-hidden`で画面全体を使用
- **UIコントロールの位置調整**: `top-2 left-2`で上部に余白確保
- **背景透明度の向上**: `bg-opacity-80`で視認性向上
- **パディングの最適化**: `p-2`でコンパクトなデザイン

#### 3. 行動履歴の位置調整
```typescript
// ズームコントロールと重ならないよう右側に配置
<div className="fixed top-2 left-60 bg-black bg-opacity-80 text-white p-2 rounded-lg shadow-lg text-sm z-50 max-w-sm">
```

#### 4. 親コンポーネントのレイアウト修正
```typescript
// ゲーム画面を全画面で表示
<div className="h-screen bg-gray-100 dark:bg-gray-900 overflow-hidden">
  <div className="w-full h-full">
    <GameGrid />
  </div>
</div>
```

### 効果
- **UIコントロールの確実な表示**: 画面サイズに関係なくコントロールが表示される
- **レスポンシブ対応**: 様々な画面サイズで適切に動作
- **視認性の向上**: 背景透明度とパディングの最適化
- **操作性の向上**: UIコントロールが重ならず、使いやすい配置

この修正により、どのような画面サイズでもUIコントロールが確実に表示され、快適にゲームを操作できるようになりました。

## 対戦終了機能の追加

### 実装内容

#### 1. 対戦終了ボタンの追加
- **位置**: 画面右下に配置
- **デザイン**: 赤色の目立つボタンで「対戦終了」と表示
- **スタイル**: ホバー時の色変化とトランジション効果

#### 2. WebSocketメッセージ送信
```typescript
const handleEndMatch = () => {
  if (readyState === WebSocket.OPEN && playerId) {
    const messageData = {
      type: "cancel_matching" as const,
      playerId: playerId,
    };
    console.log("対戦終了メッセージを送信:", messageData);
    sendMessage(messageData);
  }
};
```

#### 3. WebSocketメッセージ受信処理

**cancel_matching_result の処理:**
```typescript
const handleCancelMatchingResult = (data: WebSocketMessage) => {
  if (data.type === "cancel_matching_result") {
    console.log("対戦終了結果を受信:", data);
    if (data.status === "success") {
      console.log("対戦が正常に終了されました。ホーム画面に戻ります。");
      navigate("/", { replace: true });
    }
  }
};
```

**opponent_cancelled_match の処理:**
```typescript
const handleOpponentCancelledMatch = (data: WebSocketMessage) => {
  if (data.type === "opponent_cancelled_match") {
    console.log("相手が対戦を終了しました:", data);
    alert(data.message || "相手が対戦を終了しました。ホーム画面に戻ります。");
    navigate("/", { replace: true });
  }
};
```

#### 4. WebSocketMessage型の拡張
```typescript
export interface WebSocketMessage {
  // ...existing types...
  opponentPlayerId?: string; // opponent_cancelled_match用
  // ...
}
```

### 機能の流れ

1. **対戦終了ボタン押下**
   - ユーザーが右下の「対戦終了」ボタンをクリック
   - `cancel_matching`メッセージをWebSocketサーバーに送信

2. **サーバーからの応答処理**
   - `cancel_matching_result`受信時: 成功ステータスの場合ホーム画面に遷移
   - `opponent_cancelled_match`受信時: アラート表示後ホーム画面に遷移

3. **画面遷移**
   - `navigate("/", { replace: true })`でホーム画面に戻る
   - `replace: true`で履歴を置き換え、戻るボタンで再びゲーム画面に戻ることを防止

### UIの改善
- **対戦終了ボタン**: 右下に配置して他のUIと重ならない
- **視認性**: 赤色で重要性を強調
- **ユーザビリティ**: ホバー効果で操作性を向上

この実装により、ユーザーは任意のタイミングで対戦を終了でき、相手が対戦を終了した場合も適切に通知されるようになりました。