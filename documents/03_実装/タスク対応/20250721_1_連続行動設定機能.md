# ユーザビリティ改善：連続行動設定機能

## 実装内容

### 🎯 **変更の目的**

従来のワークフロー（キャラクター選択 → 行動設定 → キャラクター選択解除の繰り返し）から、**一度選択したキャラクターで複数の行動を連続設定**できるワークフローに変更しました。

### 📝 **ワークフローの変更**

#### 修正前
```
キャラクター選択 → 移動 → トリガー設定 → [選択解除]
↓
キャラクター選択 → 移動 → トリガー設定 → [選択解除]  
↓
キャラクター選択 → 移動 → トリガー設定 → [選択解除]
```

#### 修正後
```
キャラクター選択 → 移動 → トリガー設定 → 移動 → トリガー設定 → 移動 → トリガー設定
                                    ↑                ↑                ↑
                              行動力が残っている場合は選択を維持
```

### 🔧 **実装の詳細**

#### 1. トリガー設定完了時の選択維持
**修正箇所**: `finishTriggerSetting()` メソッド

```typescript
private finishTriggerSetting() {
  // 行動力を消費
  this.consumeActionPoint();
  
  // 行動履歴を記録
  this.recordActionHistory();

  this.triggerSettingMode = false;
  this.triggerSettingType = null;
  this.clearTriggerDisplay();

  // 行動力が残っているかチェック
  const remainingActionPoints = this.selectedCharacter 
    ? this.characterActionPoints.get(this.selectedCharacter) || 0 
    : 0;

  if (remainingActionPoints > 0) {
    // 🆕 行動力が残っている場合：キャラクター選択を維持
    console.log(`行動力が${remainingActionPoints}残っています。次の行動を設定してください。`);
    this.showMovableHexes(); // 移動可能マスを再表示
    
    // React側にキャラクター選択維持を通知
    const characterId = this.characterIds.get(this.selectedCharacter!) || null;
    notifyCharacterSelection(characterId, remainingActionPoints);
  } else {
    // 行動力が0の場合：従来通り選択をクリア
    console.log("行動力が0になりました。キャラクター選択をクリアします。");
    this.clearSelection();
  }
}
```

#### 2. キャラクター切り替え時の警告
**修正箇所**: `selectCharacter()` メソッド

```typescript
private selectCharacter(character: Phaser.GameObjects.Image) {
  // 🆕 既に別のキャラクターが選択されている場合の確認
  if (this.selectedCharacter && this.selectedCharacter !== character) {
    const currentActionPoints = this.characterActionPoints.get(this.selectedCharacter) || 0;
    if (currentActionPoints > 0) {
      const currentCharacterId = this.characterIds.get(this.selectedCharacter) || "不明";
      const newCharacterId = this.characterIds.get(character) || "不明";
      console.log(`警告: キャラクター${currentCharacterId}の行動が残っています（残り${currentActionPoints}回）。`);
      console.log(`キャラクター${newCharacterId}に切り替えますか？ 前のキャラクターの設定は保持されます。`);
    }
  }
  
  // 新しいキャラクターを選択（従来の処理）
  // ...
}
```

### 🎮 **新しいプレイヤー体験**

#### 基本的な操作フロー
1. **キャラクター選択**: 行動させたいキャラクターをクリック
2. **移動設定**: 移動先マスをクリック → メイン・サブトリガー方向を設定
3. **連続行動**: 行動力が残っている場合、自動的に次の移動可能マスが表示
4. **継続設定**: 行動力がなくなるまで2-3を繰り返し
5. **自動切り替え**: 行動力が0になると自動的に選択解除

#### 特殊ケース
- **キャラクター切り替え**: 行動力が残っているキャラクターから別のキャラクターに切り替える場合、警告メッセージを表示
- **設定保持**: 前のキャラクターの設定は保持され、後で戻って続きを設定可能

### ✅ **改善効果**

#### 操作効率の向上
- **クリック数削減**: キャラクター選択の回数が最大3分の1に減少
- **作業継続性**: 一つのキャラクターの行動をまとめて設定可能
- **直感的操作**: 自然な流れで複数行動を設定

#### ユーザビリティの向上
- **視覚的継続性**: キャラクター選択状態が維持されるため、どのキャラクターを操作中か明確
- **エラー防止**: 警告メッセージで意図しないキャラクター切り替えを防止
- **柔軟性**: 必要に応じて他のキャラクターに切り替え可能

### 🔄 **既存機能との互換性**

- **行動力システム**: 従来通りの行動力消費・管理
- **行動履歴**: 各行動は個別に記録され、実行順序も保持
- **戦闘システム**: 行動実行時の戦闘判定に影響なし
- **UI表示**: React側の行動力表示やキャラクター状態表示は従来通り

この改善により、プレイヤーはより効率的かつ直感的にキャラクターの行動を設定できるようになりました。
