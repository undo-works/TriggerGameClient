# トリガー表示機能の実装

## 実装された機能

### 🎯 **ユニット行動モード専用のトリガー表示**

ユニット行動モード中にのみ、全キャラクターのトリガー方向を視覚的に表示する機能を実装しました。

#### 主な特徴

1. **扇形でのトリガー表示**
   - メイントリガー: 赤系クリアカラー（#ff4444、透明度30%）
   - サブトリガー: 青系クリアカラー（#4444ff、透明度20%）
   - 扇形の範囲: 60度、半径3ヘックス

2. **ラベル表示**
   - 各トリガーに「Main」「Sub」のラベルを表示
   - メイン：赤色、サブ：青色のテキスト
   - ラベルは白背景で見やすく配置

3. **表示タイミング**
   - ✅ ユニット行動モード開始時（executeAllActions実行時）
   - ✅ 行動フェーズ完了時に自動クリア
   - ❌ 動きの設定モードでは表示しない

4. **🆕 キャラクターの移動に追従するアニメーション**
   - キャラクターの移動アニメーション中にトリガー表示もリアルタイムで追従
   - 扇形とラベルが滑らかに移動し、違和感を解消
   - 60FPSでのスムーズな追従を実現

5. **🆕 アクションごとのトリガー方向変更**
   - 各移動ステップでトリガーの向きが個別に更新
   - 行動履歴の各アクションに記録されたトリガー方向を反映
   - 移動→トリガー回転→移動の滑らかな連続アニメーション

### 📝 **実装詳細**

#### 表示制御ロジック

```typescript
private showTriggerDirections(character: Phaser.GameObjects.Image) {
  // 行動モード中のみ表示
  if (!this.isActionMode) return;
  // ... トリガー表示処理
}
```

#### 🆕 リアルタイム追従システム

```typescript
// キャラクターアニメーション中のトリガー追従
this.tweens.add({
  targets: character,
  x: targetPixelPos.x,
  y: targetPixelPos.y,
  duration: 1000,
  ease: "Power2",
  onUpdate: () => {
    // 移動中もトリガー表示をリアルタイム更新
    if (this.isActionMode) {
      this.updateTriggerPositionsForCharacter(character);
    }
  },
  onComplete: () => {
    // 最終位置でのトリガー表示更新
    this.showTriggerDirections(character);
  }
});
```

#### 🆕 アクションごとのトリガー方向制御

```typescript
const moveToNextAction = () => {
  const action = actions[currentActionIndex];
  
  // このアクションのトリガー方向を設定
  this.characterDirections.set(character, {
    main: action.mainAzimuth,
    sub: action.subAzimuth,
  });
  
  // アニメーション実行
  this.tweens.add({...});
};
```

#### 🔧 アニメーション追従メソッド

```typescript
private updateTriggerPositionsForCharacter(character: Phaser.GameObjects.Image) {
  // キャラクターの現在のピクセル位置に基づいてトリガー表示を更新
  const currentX = character.x;
  const currentY = character.y;
  
  // 扇形とラベルの位置をリアルタイム更新
  this.drawTriggerFanShape(display, currentX, currentY, direction, color, alpha);
}
```

#### 色設定（動きの設定モードに合わせた配色）

- **メイントリガー**: `0xff4444` (赤系)
- **サブトリガー**: `0x4444ff` (青系)
- **ラベル色**: メイン `#ff4444`、サブ `#4444ff`

#### 表示タイミングの管理

1. **行動モード開始時**
   ```typescript
   // executeAllActions内
   [...this.playerCharacters, ...this.enemyCharacters].forEach(character => {
     this.showTriggerDirections(character);
   });
   ```

2. **行動モード終了時**
   ```typescript
   // completeActionPhase内
   this.clearAllTriggerDisplays();
   ```

### 🎮 **プレイヤー体験**

#### 動きの設定モード
- キャラクター選択: トリガー表示なし（スッキリとした画面）
- 移動・トリガー設定: 既存の黄色扇形のみ表示
- 設定完了: トリガー表示なし

#### ユニット行動モード  
- 行動開始: 全キャラクターのトリガー方向が一斉に表示
- 移動中: **🆕 トリガー表示がキャラクターと一緒に滑らかに移動**
- アクション変更: **🆕 各移動ステップでトリガー方向が動的に変更**
- 行動完了: トリガー表示が自動的にクリア

### 🔧 **技術的なポイント**

#### 🆕 アニメーション追従システム
- Phaser.js の `onUpdate` コールバックを活用
- 毎フレーム実行されるリアルタイム更新
- Graphics オブジェクトの `clear()` + 再描画で滑らかな追従

#### 🆕 アクションベースのトリガー制御
- 各アクションに記録されたトリガー方向を個別に反映
- `characterDirections.set()` でアクションごとに方向更新
- 移動完了時ではなく移動開始時にトリガー方向を変更

#### モード判定による表示制御
```typescript
if (!this.isActionMode) return;
```

#### メモリ管理の改善
- 行動モード終了時の確実なクリア
- ラベルも含めた完全な削除
- Map による効率的な管理

#### 視認性の向上
- 動きの設定モードと同じ色系統を使用
- 適切な透明度でゲームボードが見える
- 重複表示時も両方のトリガーが識別可能

### ✅ **解決された課題**

1. ✅ 動きの設定モード時の不要な表示を除去
2. ✅ ユニット行動モードでのトリガー方向の可視化
3. ✅ 既存のUI配色との統一感
4. ✅ 適切なタイミングでの表示制御
5. ✅ **🆕 キャラクター移動中のトリガー表示の違和感を解消**
6. ✅ **🆕 アクションごとのトリガー方向変更を実装**

この実装により、プレイヤーは行動実行時にのみトリガー情報を確認でき、設定時は集中してキャラクターの操作を行えるようになりました。さらに、キャラクターの移動中もトリガー表示が滑らかに追従することで、より自然で直感的なゲーム体験を提供します。

### 📝 **実装詳細**

#### 新しく追加されたメソッド

1. **`showTriggerDirections(character)`**
   - 指定されたキャラクターのトリガー方向を表示
   - メイン・サブ両方のトリガーを扇形で描画
   - 方向を示すラベルも表示

2. **`createTriggerDisplay(centerX, centerY, direction, color, alpha)`**
   - トリガー扇形の描画を行う汎用メソッド
   - 指定された色と透明度で扇形を描画

3. **`clearAllTriggerDisplays()`**
   - 全キャラクターのトリガー表示をクリア
   - ラベルも含めて削除

4. **`clearTriggerDisplayForCharacter(character)`**
   - 特定キャラクターのトリガー表示をクリア
   - ラベルも含めて削除

#### 管理データ構造

```typescript
private triggerDisplays: Map<Phaser.GameObjects.Image, {
  mainTrigger: Phaser.GameObjects.Graphics | null;
  subTrigger: Phaser.GameObjects.Graphics | null;
}> = new Map();
```

### 🎮 **使用方法**

#### プレイヤーの操作フロー

1. **キャラクター選択**
   - キャラクターをクリックすると現在のトリガー方向が表示される
   - 青色＝メイントリガー、緑色＝サブトリガー

2. **移動時の表示**
   - 移動可能なマスと共にトリガー方向も表示
   - 移動後も新しい位置でトリガー方向を継続表示

3. **トリガー設定時**
   - トリガー設定中はリアルタイムで表示が更新
   - 設定完了後も新しい方向で表示される

4. **表示クリア**
   - キャラクター選択解除時
   - 行動フェーズ完了時
   - 新しいターン開始時

### 🔧 **技術的な実装ポイント**

#### 扇形描画の計算

```typescript
const radius = this.hexRadius * 3;
const fanAngle = 60; // 60度の扇形
const startAngle = (direction - fanAngle / 2) * (Math.PI / 180);
const endAngle = (direction + fanAngle / 2) * (Math.PI / 180);
```

#### ラベル位置の計算

```typescript
const labelX = centerX + Math.cos(direction * Math.PI / 180) * this.hexRadius * 2;
const labelY = centerY + Math.sin(direction * Math.PI / 180) * this.hexRadius * 2;
```

#### メモリ管理

- Graphics オブジェクトとText オブジェクトを適切に destroy()
- Map によるキャラクターとトリガー表示の紐付け管理
- データ保存でのラベル参照管理

### 🎨 **視覚的な効果**

- **色分け**: メイン（青）とサブ（緑）で直感的に識別可能
- **透明度**: 背景のゲームボードが見えるよう調整
- **ラベル**: 小さく目立たないが識別しやすいデザイン
- **重複表示**: 扇形が重なっても両方見えるよう透明度を調整

### ✅ **改善点**

実装により以下の問題が解決されました：

1. ✅ トリガーの向きが視覚的に分からない問題
2. ✅ メイン・サブの区別が困難な問題  
3. ✅ 移動時のトリガー方向の確認が困難な問題
4. ✅ 戦術的な判断材料の不足

この実装により、プレイヤーはより戦術的にゲームを進めることができ、トリガーの向きを考慮した戦略的な移動が可能になりました。

# トリガーの長さが反映されてない