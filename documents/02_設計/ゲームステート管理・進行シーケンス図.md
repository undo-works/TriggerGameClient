# ゲームステート管理・キャラクター位置管理・進行シーケンス図

現在のTriggerAppのゲームステート管理とキャラクターの位置管理、ゲームの進行に着目したシーケンス図を以下に示します。

## 1. ゲーム初期化シーケンス

```mermaid
sequenceDiagram
    participant User as プレイヤー
    participant React as Reactコンポーネント
    participant WS as WebSocketContext
    participant Phaser as PhaserScene
    participant CM as CharacterManager
    participant CS as CombatSystem

    User->>React: ゲーム画面へアクセス
    React->>WS: WebSocket接続開始
    WS->>WS: connect()
    WS-->>React: 接続確立通知

    React->>Phaser: GridSceneシーン作成
    Phaser->>Phaser: preload() - アセット読み込み
    Phaser->>Phaser: create() - ゲーム初期化
    
    Phaser->>CM: CharacterManager作成
    CM->>CM: createPlayerCharacters()
    CM->>CM: createEnemyCharacters()
    
    loop 各キャラクター
        CM->>CM: キャラクター配置
        CM->>CM: characterState.positions.set()
        CM->>CM: characterState.ids.set()
        CM->>CM: characterState.directions.set()
        CM->>CM: characterState.actionPoints.set()
    end

    Phaser->>CS: CombatSystem作成
    CS->>CS: initializeCharacterStats()
    
    Phaser-->>React: ゲーム初期化完了
```

## 2. キャラクター選択・行動設定シーケンス

```mermaid
sequenceDiagram
    participant User as プレイヤー
    participant Phaser as PhaserScene
    participant React as Reactコンポーネント

    User->>Phaser: キャラクタークリック
    Phaser->>Phaser: selectCharacter()
    
    alt 行動力チェック
        Phaser->>Phaser: characterActionPoints.get()
        alt 行動力 > 0
            Phaser->>Phaser: 選択可能
        else 行動力 = 0
            Phaser-->>User: "行動完了済み"メッセージ
            Note over Phaser: 処理終了
        end
    end
    
    alt 他キャラクター選択中
        Phaser->>Phaser: 現在選択キャラの行動力チェック
        alt 行動力 > 0
            Phaser-->>User: 警告メッセージ表示
            Note over Phaser: "前のキャラクターの設定は保持"
        end
    end

    Phaser->>Phaser: clearSelection()
    Phaser->>Phaser: selectedCharacter = character
    Phaser->>Phaser: showMovableHexes()
    Phaser->>React: notifyCharacterSelection()
    React-->>User: UI更新（選択状態表示）

    User->>Phaser: 移動先マスクリック
    Phaser->>Phaser: moveCharacterToHex()
    Phaser->>Phaser: 行動履歴に追加
    Phaser->>Phaser: 行動力を1減少
    Phaser->>Phaser: enterTriggerSettingMode()
    Phaser-->>User: トリガー設定モード開始
    
    User->>Phaser: トリガー方向設定
    Phaser->>Phaser: setTriggerDirections()
    
    alt 行動力チェック
        Phaser->>Phaser: characterActionPoints.get()
        alt 行動力 > 0
            Phaser->>Phaser: 選択維持（連続行動）
            Phaser->>Phaser: showMovableHexes()
            Note over Phaser: 次の行動設定へ
        else 行動力 = 0
            Phaser->>Phaser: clearSelection()
            Phaser->>Phaser: showActionCompletedText()
            Note over Phaser: キャラクター行動完了
        end
    end
```

## 3. 全キャラクター行動完了・ターン実行シーケンス

```mermaid
sequenceDiagram
    participant User as プレイヤー
    participant React as Reactコンポーネント
    participant Phaser as PhaserScene
    participant WS as WebSocketContext
    participant Server as サーバー

    Phaser->>Phaser: checkAllCharactersActionPointsCompleted()
    
    loop 全プレイヤーキャラクター
        Phaser->>Phaser: characterActionPoints.get()
    end
    
    alt 全キャラクター行動力 = 0
        Phaser->>Phaser: sendActionHistoryToServer()
        Phaser->>WS: sendMessage(submit_actions)
        WS->>Server: アクション履歴送信
        
        Server->>Server: 敵AI行動計算
        Server->>WS: enemy_action_submitted
        WS->>Phaser: 敵アクション受信
        
        Phaser->>Phaser: startActionMode()
        Phaser->>Phaser: isActionMode = true
        
        par プレイヤーキャラクター行動
            loop 各プレイヤーキャラクター
                Phaser->>Phaser: animatePlayerCharacterByActionSequence()
                Phaser->>Phaser: executeCharacterSingleStep()
                Phaser->>Phaser: 位置更新
                Phaser->>Phaser: updateTriggerPositionsForCharacter()
            end
        and 敵キャラクター行動
            loop 各敵キャラクター
                Phaser->>Phaser: animateCharacterByActionSequence()
                Phaser->>Phaser: executeCharacterSingleStep()
                Phaser->>Phaser: 位置更新（座標反転）
            end
        end
        
        Phaser->>Phaser: 全アニメーション完了待機
        Phaser->>Phaser: resetAllActionPoints()
        Phaser->>Phaser: isActionMode = false
        Phaser-->>User: 次ターン開始
    end
```

## 4. 戦闘システム・ステート更新シーケンス

```mermaid
sequenceDiagram
    participant Phaser as PhaserScene
    participant CS as CombatSystem
    participant CM as CharacterManager

    Phaser->>Phaser: キャラクター移動完了
    Phaser->>CS: executeCombatChecksForCharacter()
    CS->>CS: checkCombatTriggers()
    
    loop 全キャラクター
        CS->>CS: updateActiveTriggerAreas()
        CS->>CS: キャラクター位置取得
        CS->>CS: トリガー方向・射程計算
        
        loop トリガーエリア内の敵
            CS->>CS: calculateCombatResult()
            CS->>CS: ダメージ・回避計算
            
            alt ヒット
                CS->>CS: HPダメージ適用
                CS->>CS: updateHpDisplay()
                alt HP <= 0
                    CS->>CS: handleCharacterDefeat()
                    CS->>CM: キャラクター除去
                end
            else 回避
                CS->>CS: 回避カウント増加
            end
        end
        
        CS->>CS: displayCombatSummaryOnCharacters()
    end
    
    CS-->>Phaser: 戦闘結果返却
```

## 5. キャラクター状態管理の詳細

```mermaid
sequenceDiagram
    participant Phaser as PhaserScene
    participant CM as CharacterManager
    participant State as CharacterState

    Note over State: CharacterState Maps
    Note over State: - positions: Map<Character, Position>
    Note over State: - ids: Map<Character, string>
    Note over State: - directions: Map<Character, {main, sub}>
    Note over State: - actionPoints: Map<Character, number>
    Note over State: - combatStats: Map<Character, CombatStats>

    CM->>State: キャラクター作成時
    CM->>State: positions.set(character, {col, row})
    CM->>State: ids.set(character, characterId)
    CM->>State: directions.set(character, {main: 300, sub: 300})
    CM->>State: actionPoints.set(character, activeCount)

    Phaser->>State: キャラクター移動時
    Phaser->>State: positions.set(character, newPosition)
    Phaser->>State: actionPoints.set(character, points - 1)

    Phaser->>State: トリガー設定時
    Phaser->>State: directions.set(character, {main, sub})

    CM->>State: キャラクター検索
    CM->>State: findCharacterById()
    State-->>CM: characterオブジェクト

    CM->>State: 位置取得
    CM->>State: positions.get(character)
    State-->>CM: {col, row}
```

## 6. WebSocket通信・ゲーム進行管理

```mermaid
sequenceDiagram
    participant Client as クライアント
    participant WS as WebSocketContext
    participant Server as サーバー

    Client->>WS: マッチング開始
    WS->>Server: matchmaking
    Server-->>WS: match_found
    WS-->>Client: マッチ成立通知

    loop ゲームターン
        Client->>WS: アクション送信
        WS->>Server: submit_actions
        Server->>Server: 敵AI計算
        Server-->>WS: enemy_action_submitted
        WS-->>Client: 敵アクション受信
        
        Client->>Client: 全キャラクター行動実行
        Client->>Client: 戦闘処理
        Client->>Client: ターン終了処理
    end

    alt ゲーム終了条件
        Server-->>WS: game_state_update
        WS-->>Client: ゲーム結果
    end
```

## 主要なステート管理ポイント

### 1. キャラクター状態管理
- **CharacterState**: 全キャラクターの位置、ID、方向、行動力を一元管理
- **CombatSystem**: HP、戦闘統計、スタン状態を管理
- **位置同期**: 移動時にpositionsマップを即座に更新

### 2. ゲーム進行制御
- **行動力管理**: 各キャラクターの残り行動数を追跡
- **ターン制御**: 全キャラクター行動完了で次ターンへ
- **モード切替**: 設定モード ↔ 行動モード の状態管理

### 3. 非同期処理とアニメーション
- **並列アニメーション**: プレイヤー・敵キャラクターの同時行動
- **リアルタイム更新**: 移動中のトリガー表示追従
- **戦闘タイミング**: 各キャラクター移動完了時に戦闘判定

### 4. WebSocket状態同期
- **接続状態管理**: connecting/connected/disconnected
- **メッセージキュー**: アクション履歴の蓄積と一括送信
- **エラーハンドリング**: 接続失敗時の再接続制御

このシーケンス図は、現在のゲームの複雑なステート管理と、リアルタイム通信を含むゲーム進行の詳細な流れを示しています。
